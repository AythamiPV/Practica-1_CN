<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üé£ Inventario de Pesca</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      border-radius: 12px;
      padding: 20px 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 26px;
      color: #185a9d;
    }

    .btn {
      background: #185a9d;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      cursor: pointer;
      transition: 0.3s;
    }

    .btn:hover {
      background: #124574;
    }

    .btn-secondary {
      background: #eee;
      color: #333;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: 0.3s;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .card h3 {
      color: #185a9d;
      margin-bottom: 10px;
    }

    .card p {
      margin: 6px 0;
      color: #333;
    }

    .card-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #eee;
      border-radius: 6px;
      box-sizing: border-box;
    }

    input:focus, textarea:focus {
      border-color: #43cea2;
      outline: none;
    }

    .config {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 400px;
      margin: 50px auto;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- Configuraci√≥n de API URL y API Key -->
  <div id="config" class="config">
    <h2>‚öôÔ∏è Configuraci√≥n del API</h2>
    <p>Introduce la URL del API Gateway (por ejemplo: <b>https://xxxx.execute-api.us-east-1.amazonaws.com/prod</b>)</p>
    <input type="text" id="apiUrl" placeholder="URL del API" style="margin-top:10px; padding:8px;" />
    <div class="form-group" style="margin-top:15px;">
      <label>Clave del API Gateway *</label>
      <input type="text" id="apiKey" placeholder="Clave API" />
    </div>
    <button class="btn" style="width:100%; margin-top:15px;" onclick="saveConfig()">Guardar y Conectar</button>
  </div>

  <!-- Aplicaci√≥n principal -->
  <div id="app" style="display:none;">
    <div class="header">
      <h1>üé£ Inventario de Pesca</h1>
      <div>
        <button class="btn" onclick="openModal()">+ Nuevo Producto</button>
        <button class="btn-secondary btn" onclick="refresh()">üîÑ Actualizar</button>
        <button class="btn-secondary btn" onclick="logout()">‚öôÔ∏è Cambiar API</button>
      </div>
    </div>

    <div id="errorContainer"></div>
    <div class="grid" id="productsGrid"></div>
  </div>

  <!-- Modal para crear/editar producto -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Nuevo Producto</h2>
      <form id="productForm">
        <div class="form-group">
          <label>Nombre *</label>
          <input type="text" id="name" required />
        </div>
        <div class="form-group">
          <label>Descripci√≥n</label>
          <textarea id="description"></textarea>
        </div>
        <div class="form-group">
          <label>Precio (‚Ç¨)</label>
          <input type="number" id="price" step="0.01" />
        </div>
        <div class="form-group">
          <label>Cantidad</label>
          <input type="number" id="quantity" min="0" />
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button type="button" class="btn-secondary btn" onclick="closeModal()">Cancelar</button>
          <button type="submit" class="btn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let API_URL = '';
    let API_KEY = '';
    let products = [];
    let currentId = null;

    window.onload = () => {
      // Cargar configuraci√≥n guardada
      const savedUrl = localStorage.getItem('apiUrl');
      const savedKey = localStorage.getItem('apiKey');

      if (savedUrl && savedKey) {
        document.getElementById('apiUrl').value = savedUrl;
        document.getElementById('apiKey').value = savedKey;
        API_URL = savedUrl.endsWith('/') ? savedUrl.slice(0, -1) : savedUrl;
        API_KEY = savedKey;
        document.getElementById('config').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        loadProducts();
      }
    };

    function saveConfig() {
      const url = document.getElementById('apiUrl').value.trim();
      const key = document.getElementById('apiKey').value.trim();

      if (!url || !key) {
        alert('Por favor, completa ambos campos: URL y Clave API.');
        return;
      }

      API_URL = url.endsWith('/') ? url.slice(0, -1) : url;
      API_KEY = key;

      localStorage.setItem('apiUrl', API_URL);
      localStorage.setItem('apiKey', API_KEY);

      document.getElementById('config').style.display = 'none';
      document.getElementById('app').style.display = 'block';

      loadProducts();
    }

    function logout() {
      if (confirm('¬øSeguro que quieres cambiar la configuraci√≥n?')) {
        localStorage.removeItem('apiUrl');
        localStorage.removeItem('apiKey');
        API_URL = '';
        API_KEY = '';
        products = [];
        currentId = null;
        document.getElementById('app').style.display = 'none';
        document.getElementById('config').style.display = 'block';
        hideError();
        clearProductsGrid();
      }
    }

    function clearProductsGrid() {
      document.getElementById('productsGrid').innerHTML = '';
    }

    async function apiRequest(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': API_KEY
        }
      };

      if (body) {
        options.body = JSON.stringify(body);
      }
    
      try {
        const response = await fetch(`${API_URL}${endpoint}`, options);

        if (!response.ok) {
          let errorText;
          try {
            const errorJson = await response.json();
            errorText = errorJson.error || JSON.stringify(errorJson);
          } catch {
            errorText = await response.text() || response.statusText || 'Error desconocido';
          }
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
      
        if (method === 'DELETE' && response.status === 204) {
          return null;
        }
      
        return await response.json();
      } catch (error) {
        console.error('API Request failed:', error);
        throw error;
      }
    }   
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': API_KEY
        }
      };
      if (body) {
        options.body = JSON.stringify(body);
      }

      const response = await fetch(`${API_URL}${endpoint}`, options);

      if (!response.ok) {
        let errorText;
        try {
          const errorJson = await response.json();
          errorText = errorJson.error || JSON.stringify(errorJson);
        } catch {
          errorText = response.statusText || 'Error desconocido';
        }
        throw new Error(errorText);
      }

      if (method === 'DELETE') return null;

      return await response.json();
    }

    async function loadProducts() {
      try {
        hideError();
        products = await apiRequest('/products');
        renderProducts();
      } catch (error) {
        showError(`Error al cargar productos: ${error.message}`);
      }
    }

    function renderProducts() {
      hideError();
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      if (products.length === 0) {
        grid.innerHTML = '<p style="color:white;">No hay productos a√∫n.</p>';
        return;
      }
      products.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${p.name}</h3>
          <p>${p.description || ''}</p>
          <p><b>Precio:</b> ${p.price ? p.price.toFixed(2) + ' ‚Ç¨' : '-'}</p>
          <p><b>Cantidad:</b> ${p.stock ?? 0}</p>
          <div class="card-actions">
            <button class="btn" onclick="editProduct('${p.product_id || p.id}')">‚úèÔ∏è Editar</button>
            <button class="btn-secondary btn" onclick="deleteProduct('${p.product_id || p.id}')">üóëÔ∏è Eliminar</button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function openModal() {
      currentId = null;
      document.getElementById('modalTitle').textContent = 'Nuevo Producto';
      document.getElementById('productForm').reset();
      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      currentId = null;
    }

    document.getElementById('productForm').onsubmit = async (e) => {
      e.preventDefault();
      const data = {
        name: document.getElementById('name').value.trim(),
        description: document.getElementById('description').value.trim(),
        price: parseFloat(document.getElementById('price').value) || 0,
        stock: parseInt(document.getElementById('quantity').value) || 0
      };

      if (!data.name) {
        alert('El nombre es obligatorio');
        return;
      }

      try {
        if (currentId) {
          await apiRequest(`/products/${currentId}`, 'PUT', data);
        } else {
          await apiRequest('/products', 'POST', data);
        }
        closeModal();
        loadProducts();
      } catch (error) {
        showError(error.message);
      }
    };

    async function editProduct(id) {
      const product = products.find(p => (p.product_id || p.id) == id);
      if (!product) return;
      currentId = id;
      document.getElementById('modalTitle').textContent = 'Editar Producto';
      document.getElementById('name').value = product.name;
      document.getElementById('description').value = product.description || '';
      document.getElementById('price').value = product.price || 0;
      document.getElementById('quantity').value = product.stock || 0;
      document.getElementById('modal').classList.add('active');
    }

    async function deleteProduct(id) {
      if (!confirm('¬øSeguro que deseas eliminar este producto?')) return;
      try {
        await apiRequest(`/products/${id}`, 'DELETE');
        loadProducts();
      } catch (error) {
        showError(error.message);
      }
    }

    function refresh() {
      loadProducts();
    }

    function showError(msg) {
      document.getElementById('errorContainer').innerHTML = `<div class="error">${msg}</div>`;
    }

    function hideError() {
      document.getElementById('errorContainer').innerHTML = '';
    }

    document.getElementById('modal').onclick = (e) => {
      if (e.target.id === 'modal') closeModal();
    };
  </script>
</body>
</html>
